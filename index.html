<div class="stat-box" style="margin-top: 20px; border: 2px dashed #28a745;">
    <h4>شحن رصيد (QR / Code)</h4>
    <input type="text" id="coupon-input" placeholder="أدخل الكود هنا">
    <button onclick="redeemCode()" style="background-color: #28a745; color: white; padding: 5px 15px; border: none; border-radius: 5px;">تفعيل الكود</button>
</div>

<script>
    // دالة تفعيل الكود
    function redeemCode() {
        const code = document.getElementById('coupon-input').value.trim();
        if (!code) return alert("الرجاء إدخال الكود أولاً");

        // 1. التحقق من وجود الكود في قاعدة البيانات
        const couponRef = db.ref('coupons/' + code);
        
        couponRef.once('value').then((snapshot) => {
            if (snapshot.exists()) {
                const prizeValue = snapshot.val(); // القيمة (مثلاً 500 مليم)

                // 2. إضافة القيمة لحساب اللاعب
                const userRef = db.ref('players/' + currentUser + '/balance');
                userRef.transaction((currentBalance) => {
                    return (currentBalance || 0) + prizeValue;
                });

                // 3. حذف الكود من قاعدة البيانات لكي لا يستخدمه شخص آخر (استخدام لمرة واحدة)
                couponRef.remove();

                alert("مبروك! تم شحن " + prizeValue + " مليم في حسابك.");
                document.getElementById('coupon-input').value = "";
            } else {
                alert("عذراً، هذا الكود غير صالح أو تم استخدامه مسبقاً.");
            }
        });
    }
</script>
